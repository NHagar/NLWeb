<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Article Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .news-article-card {
            transition: transform 0.2s ease-in-out;
        }

        .news-article-card:hover {
            transform: translateY(-4px);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .dark input[type="range"]::-webkit-slider-track {
            background: #4b5563;
        }

        .dark input[type="range"]::-moz-range-track {
            background: #4b5563;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            /* Position the tooltip above the element */
            left: 50%;
            margin-left: -110px;
            /* Use half of the width to center */
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            /* Arrow at the bottom */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Styling for the generated content sections */
        #summary-section,
        #generated-answer-section {
            background-color: #e9f5ff;
            /* Light blue background */
            dark: bg-gray-700;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
            /* Blue left border */
        }

        #summary-section h2,
        #generated-answer-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
            /* Darker blue for heading */
            dark: text-blue-300;
            margin-bottom: 0.5rem;
        }

        #summary-section p,
        #generated-answer-section p {
            font-size: 1rem;
            line-height: 1.6;
            color: #374151;
            /* Dark gray text */
            dark: text-gray-300;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen p-4 sm:p-6 md:p-8">

    <header class="mb-8 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">Latest News</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Curated articles from GAIN.</p>
    </header>

    <div id="search-controls" class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md max-w-3xl mx-auto">
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <input type="text" id="query-input" placeholder="Search for news (e.g., 'AI advancements')"
                class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-colors">
            <button id="search-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Search
            </button>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content Mode:</label>
            <div class="flex flex-wrap gap-x-6 gap-y-2">
                <div class="tooltip">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600 dark:bg-gray-700 dark:border-gray-600"
                            name="generateMode" value="list" checked>
                        <span class="ml-2 text-gray-700 dark:text-gray-300">List Results</span>
                    </label>
                    <span class="tooltiptext">Show a ranked list of relevant articles.</span>
                </div>
                <div class="tooltip">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600 dark:bg-gray-700 dark:border-gray-600"
                            name="generateMode" value="summarize">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">Summarize</span>
                    </label>
                    <span class="tooltiptext">Provide a summary of the top articles along with the list.</span>
                </div>
                <div class="tooltip">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600 dark:bg-gray-700 dark:border-gray-600"
                            name="generateMode" value="generate">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">Generate Answer</span>
                    </label>
                    <span class="tooltiptext">Generate a direct answer to your query using relevant articles as
                        context.</span>
                </div>
            </div>
        </div>

        <div id="score-controls" class="flex flex-col sm:flex-row items-start sm:items-center gap-4"
            style="display: none;">
            <label for="score-threshold" class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">
                Score threshold:
            </label>
            <div class="flex-grow flex items-center gap-3">
                <span class="text-sm text-gray-500 dark:text-gray-400">0</span>
                <input type="range" id="score-threshold" min="0" max="1" step="0.01" value="0"
                    class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                <span id="max-score-label" class="text-sm text-gray-500 dark:text-gray-400">1</span>
                <span id="score-value"
                    class="text-sm font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded min-w-[3rem] text-center">0.00</span>
                <button id="reset-filter"
                    class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                    Reset
                </button>
            </div>
            <div id="results-counter" class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap"></div>
        </div>
    </div>

    <div id="summary-section" class="max-w-3xl mx-auto" style="display: none;">
        <h2>Summary</h2>
        <p id="summary-content"></p>
    </div>
    <div id="generated-answer-section" class="max-w-3xl mx-auto" style="display: none;">
        <h2>Generated Answer</h2>
        <p id="generated-answer-content"></p>
    </div>

    <main id="news-results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
    </main>

    <div id="loading-indicator" class="text-center py-10 text-gray-500 dark:text-gray-400" style="display: none;">
        <svg class="animate-spin h-8 w-8 text-blue-600 dark:text-blue-400 mx-auto mb-2"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
        Loading news...
    </div>

    <div id="no-results-message" class="text-center py-10 text-gray-500 dark:text-gray-400" style="display: none;">
        No articles found matching your criteria.
    </div>

    <script type="module">
        import { NewsArticleRenderer } from './news_renderer.js';

        const resultsContainer = document.getElementById('news-results-container');
        const queryInput = document.getElementById('query-input');
        const searchButton = document.getElementById('search-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noResultsMessage = document.getElementById('no-results-message');
        const scoreControls = document.getElementById('score-controls');
        const scoreThreshold = document.getElementById('score-threshold');
        const scoreValue = document.getElementById('score-value');
        const resultsCounter = document.getElementById('results-counter');
        const maxScoreLabel = document.getElementById('max-score-label');
        const resetFilterButton = document.getElementById('reset-filter');
        const generateModeRadios = document.querySelectorAll('input[name="generateMode"]');
        const summarySection = document.getElementById('summary-section');
        const summaryContent = document.getElementById('summary-content');
        const generatedAnswerSection = document.getElementById('generated-answer-section');
        const generatedAnswerContent = document.getElementById('generated-answer-content');


        let allArticles = [];
        let currentThreshold = 0;
        let currentGenerateMode = 'list'; // Default mode

        const articleRenderer = new NewsArticleRenderer({
            showAuthor: true,
            showPublisher: false,
            showDescription: false
        });

        scoreThreshold.addEventListener('input', (e) => {
            currentThreshold = parseFloat(e.target.value);
            scoreValue.textContent = currentThreshold.toFixed(2);
            renderFilteredNews();
        });

        resetFilterButton.addEventListener('click', () => {
            scoreThreshold.value = '0';
            currentThreshold = 0;
            scoreValue.textContent = '0.00';
            renderFilteredNews();
        });

        generateModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentGenerateMode = e.target.value;
                // Optionally, clear results or re-search when mode changes
                // For now, mode will apply on next search
                console.log("Generate mode changed to:", currentGenerateMode);
            });
        });

        function sortArticlesByScore(articles) {
            // Ensure articles is an array and scores are numbers before sorting
            if (!Array.isArray(articles)) return [];
            return articles.sort((a, b) => (Number(b.score) || 0) - (Number(a.score) || 0));
        }


        function filterArticlesByScore(articles) {
            if (!Array.isArray(articles)) return [];
            return articles.filter(article => (Number(article.score) || 0) >= currentThreshold);
        }

        function renderFilteredNews() {
            if (allArticles.length === 0 && currentGenerateMode === 'list') return; // Only return if no articles AND in list mode.
            // Other modes might have content even with no articles.

            let articlesToRender = allArticles;
            // Score-based filtering and sorting is most relevant for 'list' and 'summarize' modes
            if (currentGenerateMode === 'list' || currentGenerateMode === 'summarize') {
                articlesToRender = filterArticlesByScore(allArticles);
                articlesToRender = sortArticlesByScore(articlesToRender);
            }

            updateResultsCounter(articlesToRender.length, allArticles.length);
            renderNews(articlesToRender);
        }


        function updateResultsCounter(filteredCount, totalCount) {
            if (resultsCounter) {
                const scores = allArticles.map(article => article.score).filter(score => score !== undefined && score !== null);
                let counterText = `Showing ${filteredCount} of ${totalCount} articles`;
                resultsCounter.textContent = counterText;
            }
        }

        async function fetchNews(query, site = 'all', generateMode = 'list') {
            loadingIndicator.style.display = 'block';
            noResultsMessage.style.display = 'none';
            resultsContainer.innerHTML = '';
            summarySection.style.display = 'none'; // Hide summary
            generatedAnswerSection.style.display = 'none'; // Hide generated answer
            scoreControls.style.display = 'none';

            const base = window.NLWEB_HOST || window.location.origin;
            const apiUrl = new URL('/ask', base);
            apiUrl.searchParams.append('query', query);
            apiUrl.searchParams.append('site', site || 'all');
            apiUrl.searchParams.append('generate_mode', generateMode); // Use selected mode
            apiUrl.searchParams.append('streaming', 'false');

            try {
                const response = await fetch(apiUrl.toString());
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error fetching news:', response.status, errorText);
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const data = await response.json();

                let articles = [];
                if (generateMode === 'list') {
                    articles = data.results || [];
                } else if (generateMode === 'summarize') {
                    articles = data.results || [];
                    if (data.summary && data.summary.message) {
                        summaryContent.textContent = data.summary.message;
                        summarySection.style.display = 'block';
                    }
                } else if (generateMode === 'generate') {
                    // For 'generate' mode, the structure is different
                    // items are inside data.nlws.items, and answer is data.nlws.answer
                    articles = (data.nlws && data.nlws.items) ? data.nlws.items : [];
                    if (data.nlws && data.nlws.answer) {
                        generatedAnswerContent.textContent = data.nlws.answer;
                        generatedAnswerSection.style.display = 'block';
                    }
                }


                allArticles = articles;
                // Show score controls only if in 'list' or 'summarize' mode and articles exist
                if ((generateMode === 'list' || generateMode === 'summarize') && articles.length > 0) {
                    scoreControls.style.display = 'flex';
                    const scores = articles.map(article => article.score).filter(score => score !== undefined && score !== null);
                    if (scores.length > 0) {
                        const maxScore = Math.max(...scores);
                        const maxValue = Math.max(1, maxScore); // Ensure max is at least 1
                        scoreThreshold.max = maxValue.toFixed(2); // Set slider max
                        if (maxScoreLabel) {
                            maxScoreLabel.textContent = maxValue.toFixed(2);
                        }
                    }
                    scoreThreshold.value = '0';
                    currentThreshold = 0;
                    scoreValue.textContent = '0.00';
                } else {
                    scoreControls.style.display = 'none';
                }

                return articles; // Return the extracted articles
            } catch (error) {
                console.error('Failed to fetch news:', error);
                resultsContainer.innerHTML = `<p class="text-red-500 text-center col-span-full">Error loading articles. Please try again later.</p>`;
                return [];
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderNews(articles) {
            resultsContainer.innerHTML = '';

            if (!articles || articles.length === 0) {
                // Only show "no results" if not in generate mode or if generate mode also yielded no answer
                if (currentGenerateMode !== 'generate' || generatedAnswerSection.style.display === 'none') {
                    noResultsMessage.style.display = 'block';
                }
                return;
            }
            noResultsMessage.style.display = 'none';

            articles.forEach(article => {
                const itemToRender = {
                    schema_object: article.schema_object || article,
                    score: article.score, // Pass the score to the renderer
                    description: article.description // Pass the LLM's description if available
                };
                try {
                    const articleElement = articleRenderer.render(itemToRender);
                    resultsContainer.appendChild(articleElement);
                } catch (e) {
                    console.error("Error rendering article:", article, e);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'p-4 bg-red-100 text-red-700 rounded-md';
                    errorDiv.textContent = `Error rendering article: ${article.headline || 'Unknown article'}`;
                    resultsContainer.appendChild(errorDiv);
                }
            });
        }

        async function handleSearch() {
            const query = queryInput.value.trim();
            const site = "GAIN";
            if (!query) {
                resultsContainer.innerHTML = '';
                noResultsMessage.textContent = 'Please enter a search term.';
                noResultsMessage.style.display = 'block';
                scoreControls.style.display = 'none';
                summarySection.style.display = 'none';
                generatedAnswerSection.style.display = 'none';
                return;
            }
            const articles = await fetchNews(query, site, currentGenerateMode);

            // Initial rendering after fetch (renderFilteredNews will apply threshold if needed)
            renderFilteredNews(); // This will call renderNews with potentially filtered/sorted articles
        }

        searchButton.addEventListener('click', handleSearch);
        queryInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // Initial call to render if there are any default articles (e.g. from URL params)
        // For now, we assume no initial articles on page load without a search.
    </script>

</body>

</html>